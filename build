#!/usr/bin/env bash

set -euo pipefail

target=target
target_posts="${target}/posts"
target_clj="${target}/posts"
site="site"
template="template"
posts="${target}/posts.html"

compile() {
    local in="$1"
    local base="$(basename "$1")"
    local out="${target_posts}/${base%.md}.html"

    pandoc "$in" --standalone --template "${template}/post.html" -o "$out"
    cat "$out" >> "$posts"
    echo "$out"
}

extract() {
    local in="$1"
    local base="$(basename "$1")"
    local out="${target_clj}/${base%.md}.clj"
    
    pandoc --filter ./extract-codeblocks.py --to markdown "$in" | grep -vE '^```' > "$out"
    echo "$out"
}

prepare() {
    cp /dev/null "$posts"
    cp "${template}/style.css" "${site}"
}

prepare

fs=(posts/*.md)

for f in ${fs[@]}; do
    compile "$f"
    extract "$f"
done

nix-shell --command ./make-site
